<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    <title>Kokonsa App Debugger</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #results { background: #f5f5f5; padding: 10px; border: 1px solid #ddd; margin-top: 10px; }
        button { margin: 5px; padding: 5px 10px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Kokonsa App Debugger</h1>
    <div>
        <button id="checkApp">Check App</button>
        <button id="checkSW">Check Service Worker</button>
        <button id="clearCache">Clear Cache</button>
        <button id="unregisterSW">Unregister Service Worker</button>
    </div>
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const p = document.createElement('p');
            p.className = type;
            p.textContent = message;
            resultsDiv.appendChild(p);
        }

        // Check if the app is accessible
        document.getElementById('checkApp').addEventListener('click', async () => {
            log('Checking app at http://localhost:3000...');
            try {
                // Use HEAD request first to avoid CORS issues with content
                const headResponse = await fetch('http://localhost:3000', {
                    method: 'HEAD',
                    cache: 'no-cache',
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (headResponse.ok) {
                    log(`App responded to HEAD request with status: ${headResponse.status} ${headResponse.statusText}`, 'success');
                    
                    // Try to load the page in a hidden iframe to check for console errors
                    log('Attempting to load page in hidden iframe to capture console errors...', 'info');
                    
                    const timestamp = new Date().toLocaleTimeString();
                    log(`[${timestamp}] Creating iframe for testing...`, 'info');
                    
                    // Create a hidden iframe
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = 'http://localhost:3000';
                    document.body.appendChild(iframe);
                    
                    // Wait for iframe to load
                    iframe.onload = () => {
                        const loadTimestamp = new Date().toLocaleTimeString();
                        log(`[${loadTimestamp}] Iframe loaded, checking for console errors...`, 'info');
                        
                        try {
                            // Check if we can access the iframe content
                            if (iframe.contentWindow && iframe.contentWindow.document) {
                                const rootDiv = iframe.contentWindow.document.getElementById('root');
                                if (rootDiv) {
                                    log('Found root div in iframe', 'success');
                                } else {
                                    log('Root div not found in iframe', 'error');
                                }
                            } else {
                                log('Could not access iframe content due to same-origin policy', 'error');
                            }
                        } catch (iframeError) {
                            log(`Could not capture console errors: ${iframeError.message}`, 'error');
                        } finally {
                            // Remove the iframe after checking
                            setTimeout(() => {
                                document.body.removeChild(iframe);
                            }, 1000);
                        }
                    };
                    
                    iframe.onerror = (e) => {
                        log(`Iframe failed to load: ${e}`, 'error');
                        document.body.removeChild(iframe);
                    };
                } else {
                    log(`App responded with error: ${headResponse.status} ${headResponse.statusText}`, 'error');
                }
            } catch (error) {
                log(`Error checking app: ${error.message}`, 'error');
            }
        });

        // Check service worker
        document.getElementById('checkSW').addEventListener('click', async () => {
            log('Checking service worker...');
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    if (registrations.length === 0) {
                        log('No service workers registered', 'error');
                    } else {
                        log(`Found ${registrations.length} service worker registrations`, 'success');
                        registrations.forEach((reg, i) => {
                            log(`SW ${i+1} scope: ${reg.scope}`, 'info');
                            log(`SW ${i+1} state: ${reg.active ? 'active' : 'inactive'}`, 'info');
                            
                            // Check if updating
                            if (reg.installing) {
                                log(`SW ${i+1} is installing`, 'info');
                            }
                            if (reg.waiting) {
                                log(`SW ${i+1} is waiting to activate`, 'info');
                            }
                        });
                    }
                } catch (error) {
                    log(`Error checking service worker: ${error.message}`, 'error');
                }
            } else {
                log('Service Worker is not supported in this browser', 'error');
            }
        });

        // Clear cache
        document.getElementById('clearCache').addEventListener('click', async () => {
            log('Clearing caches...');
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    log(`Found ${cacheNames.length} caches`, 'info');
                    
                    const deletions = cacheNames.map(cacheName => {
                        log(`Deleting cache: ${cacheName}`, 'info');
                        return caches.delete(cacheName);
                    });
                    
                    await Promise.all(deletions);
                    log('All caches cleared successfully', 'success');
                } catch (error) {
                    log(`Error clearing caches: ${error.message}`, 'error');
                }
            } else {
                log('Cache API is not supported in this browser', 'error');
            }
        });

        // Unregister service worker
        document.getElementById('unregisterSW').addEventListener('click', async () => {
            log('Unregistering service workers...');
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    if (registrations.length === 0) {
                        log('No service workers to unregister', 'info');
                    } else {
                        const unregistrations = registrations.map(async (reg, i) => {
                            log(`Unregistering SW ${i+1} with scope: ${reg.scope}`, 'info');
                            const success = await reg.unregister();
                            if (success) {
                                log(`SW ${i+1} unregistered successfully`, 'success');
                            } else {
                                log(`Failed to unregister SW ${i+1}`, 'error');
                            }
                            return success;
                        });
                        
                        await Promise.all(unregistrations);
                        log('Service worker unregistration complete', 'success');
                    }
                } catch (error) {
                    log(`Error unregistering service workers: ${error.message}`, 'error');
                }
            } else {
                log('Service Worker is not supported in this browser', 'error');
            }
        });

        // Initial check
        log('App debugger initialized. Click buttons above to run checks.');
    </script>
</body>
</html>